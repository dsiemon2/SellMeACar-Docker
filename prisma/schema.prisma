generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// DEALERSHIP CONFIGURATION - Multi-dealership support
// ============================================

model DealershipConfig {
  id              String   @id @default(cuid())
  name            String   @default("Auto Sales Center")
  location        String   @default("123 Main Street, City, State 12345")
  phone           String   @default("(555) 123-4567")
  email           String   @default("sales@dealership.com")
  website         String   @default("")
  dealershipType  String   @default("multi_brand") // ford, chevrolet, tesla, toyota, honda, multi_brand, used, luxury
  logoUrl         String   @default("")
  primaryColor    String   @default("#1e40af")
  tagline         String   @default("Your Trusted Auto Partner")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// SALES SESSIONS - Track each training session
// ============================================

model SalesSession {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  userName        String?
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  outcome         String   @default("in_progress") // in_progress, sale_made, no_sale, abandoned
  saleConfirmed   Boolean  @default(false)
  currentPhase    String   @default("greeting") // greeting, discovery, positioning, closing, completed
  userNeeds       String   @default("{}") // JSON: discovered user preferences
  techniquesUsed  String   @default("[]") // JSON array of techniques used
  closingAttempts Int      @default(0)
  vehicleInterest String?  // ID of vehicle they're interested in
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  messages        Message[]
  analytics       SessionAnalytics?
}

model Message {
  id            String       @id @default(cuid())
  sessionId     String
  session       SalesSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role          String       // user, assistant, system
  content       String
  phase         String?      // Which sales phase this message was in
  sentiment     String?      // positive, negative, neutral, interested, skeptical
  keywords      String       @default("[]") // JSON array of detected keywords
  createdAt     DateTime     @default(now())
}

// ============================================
// SESSION ANALYTICS - Learning data per session
// ============================================

model SessionAnalytics {
  id                    String       @id @default(cuid())
  sessionId             String       @unique
  session               SalesSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  totalMessages         Int          @default(0)
  userMessageCount      Int          @default(0)
  aiMessageCount        Int          @default(0)
  avgResponseLength     Float        @default(0)
  discoveryQuestionsAsked Int        @default(0)
  objectionCount        Int          @default(0)
  positiveSignals       Int          @default(0)
  negativeSignals       Int          @default(0)
  timeToFirstInterest   Int?         // Seconds until first positive signal
  timeToClose           Int?         // Seconds until sale confirmed
  successfulTechniques  String       @default("[]") // JSON array
  failedTechniques      String       @default("[]") // JSON array
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
}

// ============================================
// CONFIGURATION - Admin configurable settings
// ============================================

model AppConfig {
  id                  String   @id @default(cuid())
  appName             String   @default("AI Auto Sales Training")
  greeting            String   @default("Welcome to our dealership! I'm here to help you find your perfect vehicle. Tell me, what brings you in today?")
  triggerPhrase       String   @default("sell me a car")
  selectedVoice       String   @default("alloy")
  aiPersona           String   @default("confident, friendly automotive sales professional")
  successKeywords     String   @default("[\"yes\", \"i'll take it\", \"i'll buy it\", \"sold\", \"deal\", \"i want it\", \"sign me up\", \"where do i sign\", \"take my money\", \"i'm in\", \"let's do it\", \"you got me\"]")
  objectionKeywords   String   @default("[\"no\", \"not interested\", \"too expensive\", \"i don't need\", \"maybe later\", \"let me think\", \"not now\"]")
  maxClosingAttempts  Int      @default(3)
  // Mode: ai_sells (AI is salesperson) or user_sells (User is salesperson)
  salesMode           String   @default("ai_sells")
  // Difficulty for user_sells mode: easy, medium, hard, expert
  difficulty          String   @default("medium")
  // Primary language code
  primaryLanguage     String   @default("en")
  updatedAt           DateTime @updatedAt
}

// ============================================
// LANGUAGES - Multi-language support
// ============================================

model Language {
  id          String   @id @default(cuid())
  code        String   @unique // en, es, fr, de, etc.
  name        String   // English, Spanish, French, etc.
  nativeName  String   // English, Espa√±ol, Fran√ßais, etc.
  flag        String   @default("üåê") // Emoji flag
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// VEHICLE INVENTORY - The vehicles being sold
// ============================================

model Vehicle {
  id              String   @id @default(cuid())
  vin             String   @unique @default("")
  stockNumber     String   @default("")
  year            Int
  make            String
  model           String
  trim            String   @default("")
  bodyStyle       String   @default("sedan") // sedan, suv, truck, coupe, convertible, van, hatchback
  exteriorColor   String
  interiorColor   String   @default("Black")
  mileage         Int      @default(0)
  condition       String   @default("new") // new, certified_preowned, used
  msrp            Float    @default(0)
  salePrice       Float
  specialPrice    Float?   // Optional promotional price
  engine          String   @default("")
  transmission    String   @default("automatic") // automatic, manual, cvt
  drivetrain      String   @default("fwd") // fwd, rwd, awd, 4wd
  fuelType        String   @default("gasoline") // gasoline, diesel, hybrid, electric, plug_in_hybrid
  mpgCity         Int?
  mpgHighway      Int?
  features        String   @default("[]") // JSON array of features
  description     String   @default("")
  images          String   @default("[]") // JSON array of image URLs
  status          String   @default("available") // available, sold, pending, reserved
  featured        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// SALES TECHNIQUES - Configurable strategies
// ============================================

model SalesTechnique {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String   // discovery, positioning, persuasion, closing, objection_handling
  description String
  script      String   // Example script/approach
  enabled     Boolean  @default(true)
  successRate Float    @default(0) // Calculated from analytics
  usageCount  Int      @default(0)
  successCount Int     @default(0)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// DISCOVERY QUESTIONS - Questions to ask customers
// ============================================

model DiscoveryQuestion {
  id          String   @id @default(cuid())
  question    String
  purpose     String   // What this question reveals
  followUp    String?  // Suggested follow-up question
  targetNeed  String   // Which need this addresses: budget, family, performance, efficiency, luxury, utility
  enabled     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
}

// ============================================
// POSITIONING ANGLES - How to frame the vehicle
// ============================================

model PositioningAngle {
  id          String   @id @default(cuid())
  userNeed    String   @unique // family, performance, efficiency, luxury, utility, value, safety
  headline    String
  pitch       String
  emotionalHook String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// ============================================
// CLOSING STRATEGIES
// ============================================

model ClosingStrategy {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   // assumptive, soft, urgency, choice, summary
  script      String
  useWhen     String   // When to use this close
  enabled     Boolean  @default(true)
  successRate Float    @default(0)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
}

// ============================================
// OBJECTION HANDLERS
// ============================================

model ObjectionHandler {
  id          String   @id @default(cuid())
  objection   String   // The objection (e.g., "too expensive", "need to think")
  category    String   // price, financing, need, timing, trust, competition, trade_in
  response    String   // How to handle it
  technique   String   // Name of technique (e.g., "feel-felt-found", "reframe")
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// ============================================
// AI SYSTEM PROMPT - Configurable AI instructions
// ============================================

model AIPromptConfig {
  id              String   @id @default(cuid())
  name            String   @unique @default("default")
  systemPrompt    String   // Main AI instructions
  discoveryPrompt String   // Instructions for discovery phase
  positioningPrompt String // Instructions for positioning phase
  closingPrompt   String   // Instructions for closing phase
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// GLOBAL ANALYTICS - Aggregate learning data
// ============================================

model GlobalAnalytics {
  id                      String   @id @default(cuid())
  date                    DateTime @default(now()) @unique
  totalSessions           Int      @default(0)
  successfulSales         Int      @default(0)
  failedSales             Int      @default(0)
  abandonedSessions       Int      @default(0)
  avgSessionDuration      Float    @default(0)
  avgMessagesToClose      Float    @default(0)
  conversionRate          Float    @default(0)
  topPerformingTechnique  String?
  mostCommonObjection     String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// ============================================
// LEARNING INSIGHTS - AI-generated insights
// ============================================

model LearningInsight {
  id          String   @id @default(cuid())
  type        String   // technique_effectiveness, objection_pattern, conversion_insight
  insight     String
  confidence  Float    @default(0)
  basedOn     Int      @default(0) // Number of sessions this is based on
  createdAt   DateTime @default(now())
}

// ============================================
// WEBHOOKS - External integrations
// ============================================

model Webhook {
  id          String   @id @default(cuid())
  name        String
  url         String
  events      String   // Comma-separated: session.started, session.ended, sale.completed, lead.captured
  secret      String   @default("")
  enabled     Boolean  @default(true)
  lastTriggered DateTime?
  failCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// SMS CONFIGURATION
// ============================================

model SmsConfig {
  id                String   @id @default(cuid())
  smsProvider       String   @default("twilio") // twilio, vonage, messagebird, plivo
  smsAccountSid     String   @default("")
  smsAuthToken      String   @default("")
  smsFromNumber     String   @default("")
  smsEnabled        Boolean  @default(false)
  smsWelcome        String   @default("Welcome to Ford Auto Sales! How can we help you find your perfect vehicle today?")
  smsFollowUp       String   @default("Hi {name}, thanks for your interest in the {vehicle}! Ready to schedule a test drive?")
  smsReminder       String   @default("Reminder: Your appointment at Ford Auto Sales is tomorrow at {time}. See you then!")
  notifyNewLead     Boolean  @default(false)
  notifyAppointment Boolean  @default(false)
  notifySale        Boolean  @default(false)
  staffNotifyNumber String   @default("")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// CALL TRANSFER CONFIGURATION
// ============================================

model CallTransferConfig {
  id                   String   @id @default(cuid())
  transferEnabled      Boolean  @default(false)
  transferTrigger      String   @default("speak to a representative")
  defaultTransferNumber String  @default("")
  transferMessage      String   @default("I will transfer you to a sales representative now. Please hold.")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model TransferDestination {
  id          String   @id @default(cuid())
  name        String
  department  String   @default("sales") // sales, service, finance, parts, manager
  phone       String
  hours       String?  // e.g., "9AM-6PM Mon-Sat"
  priority    Int      @default(1)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// DTMF (IVR) CONFIGURATION
// ============================================

model DtmfConfig {
  id           String   @id @default(cuid())
  dtmfEnabled  Boolean  @default(false)
  dtmfWelcome  String   @default("Welcome to Ford Auto Sales. Please listen to the following options.")
  dtmfInvalid  String   @default("Sorry, that option is not valid. Please try again.")
  dtmfTimeout  Int      @default(10)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model DtmfOption {
  id          String   @id @default(cuid())
  key         String   // 1-9, 0, *, #
  description String   // "Press 1 for Sales"
  action      String   @default("transfer") // transfer, ai_agent, voicemail, submenu, repeat, callback
  target      String?  // Phone number, agent name, or submenu ID
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// AI TOOLS - Extend AI capabilities
// ============================================

model AiTool {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   @default("function") // function, api, webhook
  description String
  parameters  String   @default("{}") // JSON Schema
  handler     String   @default("") // Function body or API endpoint
  enabled     Boolean  @default(true)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// AI AGENTS - Specialized AI personas
// ============================================

model AiAgent {
  id           String   @id @default(cuid())
  name         String
  role         String   @default("sales") // sales, finance, service, general, receptionist
  voice        String   @default("alloy")
  icon         String   @default("robot")
  skills       String   @default("") // Comma-separated
  priority     Int      @default(5)
  personality  String   @default("")
  systemPrompt String   @default("")
  tools        String   @default("") // Comma-separated tool names
  enabled      Boolean  @default(true)
  sessionCount Int      @default(0)
  successRate  Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// CUSTOM FUNCTIONS - User-defined logic
// ============================================

model CustomFunction {
  id          String   @id @default(cuid())
  name        String   @unique
  trigger     String   @default("manual") // manual, session_start, session_end, message_received, sale_made, scheduled
  description String   @default("")
  params      String   @default("{}") // JSON definition
  code        String   @default("") // JavaScript function body
  enabled     Boolean  @default(true)
  callCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// LOGIC RULES - Conditional AI behaviors
// ============================================

model LogicRule {
  id            String   @id @default(cuid())
  name          String
  conditionType String   @default("keyword") // keyword, sentiment, intent, context, custom
  condition     String   // Keywords or expression
  actionType    String   @default("respond") // respond, tool, transfer, tag, webhook, notify
  action        String   // Action details
  priority      Int      @default(5)
  enabled       Boolean  @default(true)
  triggerCount  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// PAYMENT CONFIGURATION
// ============================================

model PaymentConfig {
  id                   String   @id @default(cuid())
  paymentProvider      String   @default("stripe") // stripe, square, paypal, authorize
  paymentApiKey        String   @default("")
  paymentSecretKey     String   @default("")
  paymentWebhookSecret String   @default("")
  paymentTestMode      Boolean  @default(true)
  depositEnabled       Boolean  @default(false)
  defaultDeposit       Float    @default(500)
  depositType          String   @default("fixed") // fixed, percentage
  depositTerms         String   @default("Deposits are fully refundable within 48 hours. After 48 hours, deposits are applied to vehicle purchase.")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model PaymentTransaction {
  id            String   @id @default(cuid())
  customerName  String   @default("")
  customerEmail String   @default("")
  customerPhone String   @default("")
  vehicleInfo   String   @default("")
  type          String   @default("deposit") // deposit, payment, refund
  amount        Float
  status        String   @default("pending") // pending, completed, failed, refunded
  providerTxId  String   @default("") // External transaction ID
  metadata      String   @default("{}") // JSON
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// KNOWLEDGE BASE
// ============================================

model KnowledgeDoc {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  language  String   @default("en")
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  chunks    KnowledgeChunk[]
}

model KnowledgeChunk {
  id        String       @id @default(cuid())
  docId     String
  doc       KnowledgeDoc @relation(fields: [docId], references: [id], onDelete: Cascade)
  index     Int
  text      String
  embedding String       @default("[]") // JSON array of numbers
  createdAt DateTime     @default(now())
}

// ============================================
// BRANDING & SETTINGS
// ============================================

model Branding {
  id              String   @id @default(cuid())
  logoUrl         String   @default("")
  faviconUrl      String   @default("")
  primaryColor    String   @default("#dc2626") // Red
  secondaryColor  String   @default("#b91c1c")
  accentColor     String   @default("#ef4444")
  headingFont     String   @default("Inter")
  bodyFont        String   @default("Inter")
  updatedAt       DateTime @updatedAt
}

model StoreInfo {
  id              String   @id @default(cuid())
  businessName    String   @default("Sell Me a Car")
  tagline         String   @default("Your Auto Sales Partner")
  description     String   @default("AI-powered auto sales training platform")
  address         String   @default("")
  phone           String   @default("")
  email           String   @default("")
  website         String   @default("")
  businessHours   String   @default("")
  timezone        String   @default("America/New_York")
  updatedAt       DateTime @updatedAt
}

model Features {
  id                      String   @id @default(cuid())
  faqEnabled              Boolean  @default(false)
  stickyBarEnabled        Boolean  @default(false)
  stickyBarText           String   @default("")
  stickyBarBgColor        String   @default("#dc2626")
  stickyBarLink           String   @default("")
  stickyBarLinkText       String   @default("")
  liveChatEnabled         Boolean  @default(false)
  chatProvider            String   @default("builtin")
  chatWelcomeMessage      String   @default("Hi! How can we help you today?")
  chatAgentName           String   @default("Support")
  chatWidgetColor         String   @default("#dc2626")
  chatPosition            String   @default("bottom-right")
  chatShowOnMobile        Boolean  @default(true)
  chatWidgetId            String   @default("")
  chatEmbedCode           String   @default("")
  emailNotifications      Boolean  @default(true)
  smsNotifications        Boolean  @default(false)
  pushNotifications       Boolean  @default(false)
  orderConfirmations      Boolean  @default(true)
  marketingEmails         Boolean  @default(false)
  appointmentReminders    Boolean  @default(true)
  facebookEnabled         Boolean  @default(false)
  facebookUrl             String   @default("")
  twitterEnabled          Boolean  @default(false)
  twitterUrl              String   @default("")
  instagramEnabled        Boolean  @default(false)
  instagramUrl            String   @default("")
  linkedinEnabled         Boolean  @default(false)
  linkedinUrl             String   @default("")
  youtubeEnabled          Boolean  @default(false)
  youtubeUrl              String   @default("")
  tiktokEnabled           Boolean  @default(false)
  tiktokUrl               String   @default("")
  shareOnFacebook         Boolean  @default(true)
  shareOnTwitter          Boolean  @default(true)
  shareOnLinkedin         Boolean  @default(false)
  shareOnWhatsapp         Boolean  @default(true)
  shareOnEmail            Boolean  @default(true)
  copyLinkButton          Boolean  @default(true)
  updatedAt               DateTime @updatedAt
}

model PaymentSettings {
  id                    String   @id @default(cuid())
  enabled               Boolean  @default(false)
  stripeEnabled         Boolean  @default(false)
  stripePublishableKey  String   @default("")
  stripeTestMode        Boolean  @default(true)
  paypalEnabled         Boolean  @default(false)
  paypalClientId        String   @default("")
  paypalSandbox         Boolean  @default(true)
  squareEnabled         Boolean  @default(false)
  squareAppId           String   @default("")
  squareSandbox         Boolean  @default(true)
  updatedAt             DateTime @updatedAt
}
